<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wild Cafe Ella POS</title>

    <style>
        :root {
            --accent: #1e40af;
            --text-color: #1f2937;
            --text-secondary: #374151;
            --bg-light: #f8fafc;
            --panel-bg: #ffffff;
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-elevated: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            /* System font stack for guaranteed offline use */
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            color: var(--text-color);
            background: var(--bg-light);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: var(--radius-md); }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: var(--radius-md); }
        ::-webkit-scrollbar-thumb:hover { background: #1e3a8a; }

        /* Header */
        .pos-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--panel-bg); box-shadow: var(--shadow-soft);
            margin: var(--spacing-sm); border-radius: var(--radius-lg);
        }
        .header-left { display: flex; align-items: center; gap: var(--spacing-md); }
        .menu-toggle {
            width: 44px; height: 44px; border: none; background: var(--accent);
            border-radius: var(--radius-md); cursor: pointer; color: white;
            font-size: 1.25rem; display: flex; align-items: center; justify-content: center;
            transition: all .2s ease;
        }
        .menu-toggle:hover, .menu-toggle:focus { background: #1e3a8a; outline: 2px solid #93c5fd; outline-offset: 2px; }
        .header-info { text-align: center; flex-grow: 1; }
        /* Using a system font for display text as a fallback for 'Space Grotesk' */
        .header-info h2 { font-family: ui-sans-serif, system-ui, sans-serif; font-weight: 700; font-size: 1.5rem; color: var(--accent); }
        .header-info .datetime { font-size: .875rem; color: var(--text-secondary); margin-top: var(--spacing-sm); }
        .action-button {
            padding: var(--spacing-sm) var(--spacing-md); border: none; border-radius: var(--radius-md);
            font-weight: 600; cursor: pointer; font-size: .875rem; transition: all .2s ease;
        }
        .action-button:hover, .action-button:focus { outline: 2px solid #93c5fd; outline-offset: 2px; }
        .btn-primary { background: var(--accent); color: white; padding: var(--spacing-md) var(--spacing-lg); font-size: 1rem; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(30,64,175,.3); }
        .btn-primary:disabled { opacity: .6; cursor: not-allowed; background: #6b7280; }
        .btn-secondary { background-color: #e2e8f0; color: var(--text-color); }
        .btn-secondary:hover { background-color: #cbd5e1; }

        /* Slide Menu */
        .slide-menu { position: fixed; left: -280px; top: 0; width: 280px; height: 100vh;
            background: linear-gradient(180deg,#1e293b 0%,#0f172a 100%);
            box-shadow: var(--shadow-elevated); transition: left .3s ease; z-index: 2000; display: flex; flex-direction: column; }
        .slide-menu.open { left: 0; }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); opacity: 0; visibility: hidden;
            transition: opacity .3s ease; z-index: 1999; }
        .menu-overlay.visible { opacity: 1; visibility: visible; }
        .menu-header { padding: var(--spacing-lg); border-bottom: 1px solid rgba(255,255,255,.1);
            display: flex; justify-content: space-between; align-items: center; }
        /* Using a system font for display text as a fallback for 'Space Grotesk' */
        .menu-logo { font-family: ui-sans-serif, system-ui, sans-serif; font-size: 1.75rem; font-weight: 700; color: var(--accent); }
        .menu-close { background: none; border: none; color: #cbd5e1; font-size: 1.25rem; cursor: pointer; transition: .2s; }
        .menu-close:hover, .menu-close:focus { color: #fff; outline: 2px solid #93c5fd; outline-offset: 2px; }
        .menu-items { padding: var(--spacing-md) 0; flex-grow: 1; }
        .menu-item { display: flex; align-items: center; padding: var(--spacing-md) var(--spacing-lg);
            color: #cbd5e1; cursor: pointer; font-weight: 500; font-size: 1rem; transition: .2s; }
        .menu-item:hover, .menu-item:focus { background: rgba(30,64,175,.1); color: #93c5fd; }
        .menu-item.active { background: rgba(30,64,175,.2); color: #fff; border-left: 4px solid var(--accent); }
        .menu-icon { margin-right: var(--spacing-md); font-size: 1.25rem; }

        /* Layout */
        .pos-container { display: grid; grid-template-columns: 280px 2fr 1.5fr; gap: var(--spacing-md);
            padding: 0 var(--spacing-md) var(--spacing-md); max-height: calc(100vh - 90px); }
        .panel { background: var(--panel-bg); border-radius: var(--radius-lg); box-shadow: var(--shadow-soft);
            padding: var(--spacing-lg); overflow-y: auto; }
        .tables-panel { background: var(--accent); color: #fff; padding: var(--spacing-lg); }
        /* Using a system font for display text as a fallback for 'Space Grotesk' */
        .tables-panel h3 { font-family: ui-sans-serif, system-ui, sans-serif; font-size: 1.25rem; margin-bottom: var(--spacing-md); font-weight: 700; }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(80px,1fr));
            gap: var(--spacing-sm); max-height: calc(100vh - 200px); overflow-y: auto; }
        .table-card-compact { aspect-ratio: 1; border-radius: var(--radius-md); display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer; transition: .2s; border: 2px solid transparent;
            font-weight: 600; font-size: .875rem; background: #fff; box-shadow: var(--shadow-soft); }
        .table-card-compact:hover, .table-card-compact:focus { transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,.15); outline: 2px solid #93c5fd; outline-offset: 2px; }
        .status-open { background: #f8fafc; border-color: #cbd5e1; color: #64748b; }
        .status-ongoing { background: #fef3c7; border-color: #fbbf24; color: #d97706; animation: pulse 2s infinite; }
        .status-ongoing::before { content: 'Yellow'; margin-bottom: var(--spacing-sm); }
        .status-selected { background: #fff; border-color: var(--accent); color: var(--accent);
            font-weight: 700; box-shadow: 0 0 0 3px rgba(30,64,175,.2); }
        .status-selected::before { content: 'Blue'; margin-bottom: var(--spacing-sm); }
        @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .mobile-table-selector { display: none; width: 100%; padding: var(--spacing-sm) var(--spacing-md);
            border: 2px solid #e5e7eb; border-radius: var(--radius-md); font-size: .875rem; margin-bottom: var(--spacing-md);
            background: #f9fafb; transition: .2s; }
        .mobile-table-selector:focus, .mobile-table-selector:hover { border-color: var(--accent);
            outline: 2px solid #93c5fd; outline-offset: 2px; }

        .menu-panel.disabled { filter: blur(2px); pointer-events: none; opacity: .6; }
        .category-tags { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); padding-bottom: var(--spacing-sm);
            margin-bottom: var(--spacing-md); }
        .category-tag { padding: var(--spacing-sm) 1rem; border-radius: 9999px; background: #e2e8f0;
            cursor: pointer; font-size: .875rem; font-weight: 600; transition: .2s; }
        .category-tag:hover, .category-tag:focus { background: #cbd5e1; outline: 2px solid #93c5fd; outline-offset: 2px; }
        .category-tag.active { background: var(--accent); color: #fff; }
        .search-input { width: 100%; padding: var(--spacing-sm) var(--spacing-md); border: 2px solid #e5e7eb;
            border-radius: var(--radius-md); font-size: .875rem; margin-bottom: var(--spacing-md); transition: .2s; }
        .search-input:focus { outline: none; border-color: var(--accent); }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(140px,1fr));
            gap: var(--spacing-md); max-height: calc(100vh - 250px); overflow-y: auto; }
        .menu-item-card { background: linear-gradient(135deg,#f9f9fb 0%,#fff 100%);
            border-radius: var(--radius-md); padding: var(--spacing-md); text-align: center; cursor: pointer;
            border: 2px solid transparent; transition: .2s; }
        .menu-item-card:hover, .menu-item-card:focus { transform: translateY(-4px); border-color: var(--accent);
            box-shadow: var(--shadow-elevated); outline: 2px solid #93c5fd; outline-offset: 2px; }
        .item-icon { font-size: 1.75rem; margin-bottom: var(--spacing-sm); color: var(--accent); }
        .item-name { font-weight: 600; margin-bottom: var(--spacing-sm); font-size: .875rem; }
        .item-price { color: var(--accent); font-weight: 700; font-size: .875rem; }

        .current-order-panel { display: flex; flex-direction: column; height: calc(100vh - 90px); }
        .order-list { list-style: none; padding: 0; overflow-y: auto; margin-bottom: var(--spacing-md);
            flex-grow: 1; max-height: calc(100vh - 380px); }
        .order-item { display: grid; grid-template-columns: 2fr 1fr 1fr .5fr; gap: var(--spacing-sm);
            padding: var(--spacing-md); border-radius: var(--radius-md); background: #f9fafb;
            margin-bottom: var(--spacing-md); align-items: center; }
        .qty-controls { display: flex; flex-direction: column; gap: 4px; align-items: center; }
        .qty-btn { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            background: #e2e8f0; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: .875rem; transition: .2s; }
        .qty-btn:hover, .qty-btn:focus { background: #cbd5e1; outline: 2px solid #93c5fd; outline-offset: 2px; }
        .qty-value { cursor: pointer; padding: 2px 8px; font-size: .875rem; }
        .qty-value:hover, .qty-value:focus { background: #e5e7eb; border-radius: 4px; outline: 2px solid #93c5fd; outline-offset: 2px; }
        .remove-btn { background: #fee2e2; color: #ef4444; border: none; width: 32px; height: 32px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: .875rem; transition: .2s; }
        .remove-btn:hover, .remove-btn:focus { background: #fecaca; outline: 2px solid #93c5fd; outline-offset: 2px; }
        .order-summary { padding-top: var(--spacing-md); border-top: 2px solid #e5e7eb; flex-shrink: 0; }
        .summary-row { display: flex; justify-content: space-between; align-items: center;
            margin-bottom: var(--spacing-sm); font-size: .875rem; }
        .summary-row.total { font-size: 1.25rem; font-weight: 700; color: var(--accent);
            padding-top: var(--spacing-sm); border-top: 2px solid #e5e7eb; }
        .kitchen-notes { margin: var(--spacing-md) 0; flex-shrink: 0; }
        .note-checkbox { display: flex; align-items: center; margin-bottom: var(--spacing-sm); }
        .note-checkbox input { margin-right: var(--spacing-sm); cursor: pointer; }
        .custom-note { width: 100%; padding: var(--spacing-sm); border: 2px solid #e5e7eb;
            border-radius: var(--radius-md); margin-top: var(--spacing-sm); font-size: .875rem; resize: vertical; }
        .custom-note:focus { outline: none; border-color: var(--accent); }
        .order-actions { display: flex; gap: var(--spacing-sm); margin-top: var(--spacing-md); flex-shrink: 0; }
        .order-actions .action-button { flex-grow: 1; }

        /* Modals */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none;
            justify-content: center; align-items: center; z-index: 11000; opacity: 0; transition: opacity .3s ease; }
        .modal.is-active { display: flex; opacity: 1; }
        .modal-content { background: var(--panel-bg); padding: var(--spacing-lg); border-radius: var(--radius-lg);
            box-shadow: var(--shadow-elevated); width: 90%; max-width: 450px; max-height: 85vh;
            overflow-y: auto; transform: scale(.95); transition: transform .3s ease; }
        .modal.is-active .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md); }
        .modal-close { width: 32px; height: 32px; border: none; background: #e2e8f0; border-radius: 50%;
            cursor: pointer; font-size: .875rem; display: flex; align-items: center; justify-content: center;
            transition: .2s; }
        .modal-close:hover, .modal-close:focus { background: #cbd5e1; transform: rotate(90deg);
            outline: 2px solid #93c5fd; outline-offset: 2px; }
        .numpad-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: var(--spacing-sm);
            margin-top: var(--spacing-md); }
        .numpad-display { width: 100%; padding: var(--spacing-md); border: 2px solid #e5e7eb;
            border-radius: var(--radius-md); font-size: 1.25rem; text-align: right; margin-bottom: var(--spacing-md);
            background: #f9fafb; }
        .numpad-key { padding: var(--spacing-md); font-size: 1rem; min-height: 48px; transition: .2s; }
        .numpad-key:hover, .numpad-key:focus { background: #cbd5e1; outline: 2px solid #93c5fd; outline-offset: 2px; }
        .key-enter { grid-column: span 2; font-size: .875rem; }
        .payment-methods-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: var(--spacing-sm);
            margin: var(--spacing-md) 0; }
        .method-button { padding: var(--spacing-sm) var(--spacing-md); border: 2px solid #e5e7eb;
            border-radius: var(--radius-md); background: #f9fafb; cursor: pointer; text-align: center;
            font-weight: 600; font-size: .875rem; transition: .2s; }
        .method-button.active { border-color: var(--accent); background: var(--accent); color: #fff; }
        .method-button:hover, .method-button:focus { background: #e5e7eb; outline: 2px solid #93c5fd; outline-offset: 2px; }
        .payment-input { width: 100%; padding: var(--spacing-sm) var(--spacing-md); border: 2px solid #e5e7eb;
            border-radius: var(--radius-md); font-size: .875rem; margin-bottom: var(--spacing-md); }
        .payment-input:focus { outline: none; border-color: var(--accent); }

        .notification { position: fixed; bottom: 10px; right: 10px; background: #eff6ff; color: var(--accent);
            padding: var(--spacing-md) var(--spacing-lg); border-radius: var(--radius-md); box-shadow: var(--shadow-soft);
            border: 1px solid var(--accent); font-size: .875rem; font-weight: 600; display: flex; align-items: center;
            gap: var(--spacing-sm); z-index: 12000; opacity: 0; transform: translateY(20px); transition: .3s; }
        .notification.active { opacity: 1; transform: translateY(0); }

        /* Responsive */
        @media (max-width: 1024px) {
            .pos-container { grid-template-columns: 1fr 1.5fr; }
            .tables-panel { display: none; }
            .mobile-table-selector { display: block; }
            .current-order-panel { height: calc(100vh - 110px); }
            .order-list { max-height: calc(100vh - 400px); }
        }
        @media (max-width: 768px) {
            .pos-container { grid-template-columns: 1fr; gap: var(--spacing-sm); }
            .menu-panel { order: 2; }
            .current-order-panel { order: 1; height: auto; max-height: calc(100vh - 110px); }
            .order-list { max-height: calc(100vh - 420px); }
            .header-info h2 { font-size: 1.25rem; }
            .action-button { font-size: .75rem; padding: var(--spacing-sm); }
            .menu-item-card { padding: var(--spacing-sm); }
            .item-icon { font-size: 1.5rem; }
            .item-name, .item-price, .category-tag, .search-input, .mobile-table-selector { font-size: .75rem; }
        }
        @media (max-width: 600px) {
            .pos-header { flex-direction: column; gap: var(--spacing-sm); }
            .header-left, .header-actions { width: 100%; justify-content: space-between; }
            .header-info { order: -1; }
            .order-actions { flex-direction: column; }
            .order-actions .action-button { width: 100%; }
            .modal-content { max-width: 90%; }
        }
    </style>
</head>
<body>

    <div class="slide-menu" id="slide-menu">
        <div class="menu-header">
            <div class="menu-logo">Wild Cafe Ella</div>
            <button class="menu-close" onclick="toggleMenu()" aria-label="Close menu">X</button>
        </div>
        <div class="menu-items">
            <!-- <div class="menu-item active" onclick="openItemsPage()" tabindex="0">Dashboard</div> -->
            <div class="menu-item" id="open-reports-page" tabindex="0">Sales Reports</div>
     <div class="menu-item" id="past-orders-link" tabindex="0">Past Orders</div>
            <div class="menu-item" id="menu-items-link" tabindex="0">Menu Items</div>
            <div class="menu-item" id="open-categories-page" tabindex="0">Categories</div>
             <div class="menu-item" id="open-tables-page" tabindex="0">Tables</div>
            <div class="menu-item" id="open-settings-page"  tabindex="0">Settings</div>
            <div class="menu-item" id="logout-and-close" tabindex="0">Logout</div>
        </div>
    </div>
    <div class="menu-overlay" id="menu-overlay" onclick="toggleMenu()"></div>

    <header class="pos-header">
        <div class="header-left">
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Open menu"><i class="fas fa-bars"></i></button>
        </div>
        <div class="header-info">
            <h2>Wild Cafe Ella POS</h2>
            <div class="datetime" id="header-datetime"></div>
        </div>
        <div class="header-actions">
            <span id="header-table-info">Select a table to begin</span>
        </div>
    </header>

    <select class="mobile-table-selector" id="mobile-table-selector" onchange="selectTable(this.value)">
        <option value="">Select Table...</option>
    </select>

    <main class="pos-container">
        <section class="panel tables-panel">
            <h3>Tables</h3>
            <div class="tables-grid" id="tables-grid"></div>
        </section>

        <section class="panel menu-panel" id="menu-panel">
            <div class="category-tags" id="category-tags"></div>
            <input type="text" class="search-input" id="menu-search" placeholder="Search items or enter ID..." oninput="renderMenuItems(this.value)">
            <div class="menu-grid" id="menu-grid"></div>
        </section>

        <section class="panel current-order-panel">
            <h3>Current Order <span id="order-table-info"></span></h3>
            <ul class="order-list" id="current-order-list">
                <li id="empty-order-placeholder">No items added yet.</li>
            </ul>

            <div class="order-summary">
                <div class="summary-row" id="tax-row"><span>Tax (10%)</span> <span id="summary-tax">$0.00</span></div>
                <div class="summary-row"><span>Subtotal</span> <span id="summary-subtotal">$0.00</span></div>
                <div class="summary-row" id="discount-row"><span>Discount</span> <span id="summary-discount">$0.00</span></div>
                <div class="summary-row total"><span>Total</span> <span id="summary-total">$0.00</span></div>
            </div>

            <div class="kitchen-notes">
                <div class="note-checkbox"><input type="checkbox" id="less-spice"><label for="less-spice">Less Spice</label></div>
                <div class="note-checkbox"><input type="checkbox" id="no-gluten"><label for="no-gluten">No Gluten</label></div>
                <textarea class="custom-note" id="custom-note" placeholder="Custom note..."></textarea>
            </div>

            <div class="order-actions">
                <button class="action-button btn-primary" onclick="handleSendToKitchen()">Send to Kitchen</button>
                <button class="action-button btn-primary" onclick="openPaymentModal()">Pay & Print</button>
                <button class="action-button btn-secondary" onclick="clearCurrentOrder()">Clear</button>
            </div>
        </section>
    </main>

    <div class="modal" id="numpad-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="numpad-title">Enter Value</h3>
                <button class="modal-close" onclick="closeModal('numpad-modal')" aria-label="Close">X</button>
            </div>
            <div id="numpad-display">0</div>
            <div class="numpad-grid">
                <button class="numpad-key action-button" data-key="7">7</button>
                <button class="numpad-key action-button" data-key="8">8</button>
                <button class="numpad-key action-button" data-key="9">9</button>
                <button class="numpad-key action-button" data-key="DEL">DEL</button>

                <button class="numpad-key action-button" data-key="4">4</button>
                <button class="numpad-key action-button" data-key="5">5</button>
                <button class="numpad-key action-button" data-key="6">6</button>
                <button class="numpad-key action-button" data-key="C">C</button>

                <button class="numpad-key action-button" data-key="1">1</button>
                <button class="numpad-key action-button" data-key="2">2</button>
                <button class="numpad-key action-button" data-key="3">3</button>
                <button class="numpad-key action-button" data-key=".">.</button>

                <button class="numpad-key action-button" data-key="00" style="display: none;">00</button>
                <button class="numpad-key action-button" data-key="0" style="grid-column: span 2;">0</button>
                <button class="numpad-key action-button btn-primary key-enter" data-key="ENTER" style="grid-column: span 2;">ENTER</button>
            </div>
        </div>
    </div>
    <div class="modal" id="payment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Payment for <span id="payment-modal-table"></span></h3>
                <button class="modal-close" onclick="closeModal('payment-modal')" aria-label="Close">X</button>
            </div>
            <div class="summary-row"><span>Total Due</span> <span id="payment-total-due" class="total"></span></div>
            
            <label for="payment-amount">Amount Paid</label>
            <input type="text" class="payment-input" id="payment-amount" value="0.00" onfocus="openNumpad('payment', 'decimal', 0.00)" readonly>

            <label>Payment Method</label>
            <div class="payment-methods-grid" id="payment-methods">
                <button class="method-button active" data-method="Cash">Cash</button>
                <button class="method-button" data-method="Card">Card</button>
                <button class="method-button" data-method="Mobile">Mobile</button>
            </div>

            <div class="summary-row"><span>Change Due</span> <span id="payment-change" class="total">$0.00</span></div>
            
            <button class="action-button btn-primary" id="finish-bill-btn" onclick="handleConfirmPayment()">Finish Bill & Print</button>
        </div>
    </div>
    <div class="notification" id="notification">Notification message</div>

    <script>
        // --- GLOBAL STATE ---
        // REMOVED: Old hardcoded TAX_RATE, TAX_ENABLED, DISCOUNT_ENABLED
        
        // NEW: Dynamic global settings object
        let globalSettings = {
            TAX_RATE: 10, // Default 10%
            TAX_ENABLED: true, // Default true
            DISCOUNT_RATE: 0, // Default 0%
            DISCOUNT_ENABLED: true, // Default true
            CURRENCY_SYMBOL: 'Rs' // Default 'Rs'
        };
        
        // Global Currency Symbol (Kept for backward compatibility with old code that might use it directly)
        let CURRENCY_SYMBOL = globalSettings.CURRENCY_SYMBOL; 

        // Global variables for data storage
        let menuItems = [];
        let tables = [];
        let ongoingOrders = [];
        let currentOrder = { tableId: null, orderId: null, items: [], discount: 0, notes: '' };
        let activeCategory = 'All'; // Track the currently active category filter
        let isProcessing = false; // Prevent double submission
        
        // Numpad Globals
        let globalNumpadTarget = '';
        let globalNumpadMode = '';
        let selectedPaymentMode = 'Cash'; // Default payment mode

        // Date and Time update
        const updateDateTime = () => {
            const now = new Date();
            const date = now.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            const time = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('header-datetime').textContent = `${date} | ${time}`;
        };
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // ---------- UI HELPERS ----------
        const toggleMenu = () => {
            document.getElementById('slide-menu').classList.toggle('open');
            document.getElementById('menu-overlay').classList.toggle('visible');
        };

        const closeModal = id => {
            document.getElementById(id).classList.remove('is-active');
        };

        const showNotification = (msg, dur = 3000) => {
            const n = document.getElementById('notification');
            n.textContent = msg;
            n.classList.add('active');
            setTimeout(() => n.classList.remove('active'), dur);
        };

        const navigateTo = page => showNotification(`Maps to ${page} – Placeholder for Electron Function`);
        const logout = () => showNotification('Logout – Placeholder for Electron Function');

        // Nav Links
        const openItemsPage = () => { window.electronAPI.openItemsPage(); };
        document.getElementById('menu-items-link').addEventListener('click', () => { window.electronAPI.openItemsPage(); });
        document.getElementById('open-categories-page').addEventListener('click', () => { window.api.openCategoriesPage(); });
        document.getElementById('open-tables-page').addEventListener('click', () => { window.api.openTablesPage(); });
        document.getElementById('past-orders-link').addEventListener('click', () => { window.electronAPI.openOrdersPage(); });
        document.getElementById('open-settings-page').addEventListener('click', () => { window.api.openSettingsPage(); });


        // ---------- CALCULATIONS ----------
        
        /**
         * Calculates the order summary using dynamic settings.
         * @param {Array} items - List of order items.
         * @param {number} disc - The manual discount amount for the current order.
         * @returns {object} Summary object with subtotal, tax, discount, and total.
         */
        const calculateSummary = (items, disc = 0) => {
            // FIX: Ensure items is an array to prevent "Cannot read properties of undefined (reading 'reduce')"
            const sub = (items || []).reduce((s, i) => s + i.price * i.qty, 0);
            
            // 1. Calculate Tax dynamically
            const taxRateDecimal = globalSettings.TAX_RATE / 100;
            const tax = globalSettings.TAX_ENABLED ? sub * taxRateDecimal : 0;
            
            // 2. Apply Discount only if enabled in settings
            const finalDiscount = globalSettings.DISCOUNT_ENABLED ? Math.max(0, disc) : 0;
            
            // 3. Calculate Final Total
            const total = Math.max(0, sub + tax - finalDiscount);
            
            return { subtotal: sub, tax, discount: finalDiscount, total };
        };

        // UPDATED: Function to format currency using the global symbol
        const formatCurrency = value => {
            return `${globalSettings.CURRENCY_SYMBOL}${parseFloat(value).toFixed(2)}`;
        };

        const getKitchenNotes = () => {
            const notes = [];
            if (document.getElementById('less-spice').checked) notes.push('Less Spice');
            if (document.getElementById('no-gluten').checked) notes.push('No Gluten');
            const custom = document.getElementById('custom-note').value.trim();
            if (custom) notes.push(custom);
            return notes.join(' | ');
        };

        const resetKitchenNotes = () => {
            document.getElementById('less-spice').checked = false;
            document.getElementById('no-gluten').checked = false;
            document.getElementById('custom-note').value = '';
        };

        const updateMenuPanelState = () => {
            const menuPanel = document.getElementById('menu-panel');
            if (currentOrder.tableId) {
                menuPanel.classList.remove('disabled');
            } else {
                menuPanel.classList.add('disabled');
            }
        };

        const filterMenu = (cat, tagElement) => {
            document.querySelectorAll('.category-tag').forEach(t => t.classList.remove('active'));
            if (tagElement) tagElement.classList.add('active');
            activeCategory = cat;
            renderMenuItems(document.getElementById('menu-search').value);
        };

        
    document.addEventListener('DOMContentLoaded', () => {
        const logoutButton = document.getElementById('logout-and-close');

        if (logoutButton) {
            logoutButton.addEventListener('click', () => {
                // Use confirmation for user safety before closing the app
                if (confirm('Are you sure you want to log out and close the POS?')) {
                    // Call the exposed Electron API function
                    // NOTE: This relies on 'window.appAPI.logout()' being defined in preload.js
                    if (window.electronAPI && typeof window.electronAPI.logout === 'function') {
                        window.electronAPI.logout(); 
                    } else {
                        console.error('Electron API for logout not available!');
                        alert('Logout failed: System service missing.');
                    }
                }
            });
        }
    });

        // ---------- DATA FETCHING & INITIALIZATION ----------
        
        /**
         * Fetches settings from DB and updates the globalSettings object.
         */
        const fetchSettings = async () => {
            try {
                const fetchedSettings = await window.electronAPI.getSettings();
                if (fetchedSettings) {
                    // Update global settings object
                    globalSettings.TAX_ENABLED = fetchedSettings.tax_enabled == 1;
                    globalSettings.TAX_RATE = parseFloat(fetchedSettings.tax_rate) || 0;
                    globalSettings.DISCOUNT_ENABLED = fetchedSettings.discount_enabled == 1;
                    globalSettings.DISCOUNT_RATE = parseFloat(fetchedSettings.discount_rate) || 0;
                    globalSettings.CURRENCY_SYMBOL = fetchedSettings.currency_symbol || '$';
                    // Update the CURRENCY_SYMBOL variable for consistency (if needed by other code)
                    CURRENCY_SYMBOL = globalSettings.CURRENCY_SYMBOL; 
                } else {
                    showNotification("Warning: Could not load settings from database. Using defaults.");
                }
            } catch (error) {
                console.error("Failed to fetch settings:", error);
                showNotification(`Error fetching settings: ${error.message}`);
            }
        };

        const fetchData = async () => {
            if (isProcessing) return; // Prevent concurrent fetching
            isProcessing = true;
            try {
                // 1. Fetch settings first (to get currency, tax, discount rates)
                await fetchSettings();

                // 2. Fetch data from DB
                const [fetchedMenu, fetchedTables, ongoingOrdersData] = await Promise.all([
                    window.electronAPI.fetchMenu(),
                    window.electronAPI.fetchTables(),
                    window.electronAPI.fetchOngoingOrders(),
                ]);

                // 3. Process Menu Items
                // Map 'image' (from DB) to 'icon' (for UI)
                menuItems = fetchedMenu.map(i => ({ 
                    id: i.id, 
                    name: i.name, 
                    category: i.category, 
                    price: parseFloat(i.price), 
                    icon: i.image || 'fas fa-utensils', // Use 'image' from DB as icon class
                    code: i.code || null // Include code 
                }));

                // 4. Process Ongoing Orders
                ongoingOrders = ongoingOrdersData.map(order => ({
                    tableId: order.desk_id,
                    orderId: order.id,
                    items: order.products.map(p => ({
                        id: parseInt(p.id),
                        qty: parseInt(p.qty),
                        name: p.name,
                        price: parseFloat(p.price),
                        category: p.category,
                        icon: p.image,
                        code: p.code || null
                    })),
                    discount: 0, // Discount isn't stored on the sales record, keeping it at 0 for simplicity
                    notes: '', // Notes aren't stored on the sales record, keeping it blank for simplicity
                    subtotal: parseFloat(order.price) || 0, // Order price in DB is usually the subtotal/total before payment
                    total: parseFloat(order.price) || 0,
                }));
                
                // 5. Process Tables
                tables = fetchedTables.map(t => { 
                    const ongoing = ongoingOrders.find(o => o.tableId === t.id);
                    return { 
                        id: t.id, 
                        name: t.name || `Table ${t.id}`, 
                        status: ongoing ? 'ongoing' : 'open' 
                    };
                });
                
                // Re-render UI components that depend on fetched data
                renderCategoryTags();
                renderMenuItems();
                renderTables();

                // If a table was selected before the refresh, re-select it
                if (currentOrder.tableId !== null) {
                    const existingOrder = ongoingOrders.find(o => o.tableId === currentOrder.tableId);
                    if (existingOrder) {
                        currentOrder = existingOrder;
                    } else {
                        // If selected table no longer has an ongoing order, clear local state
                        currentOrder = { tableId: currentOrder.tableId, orderId: null, items: [], discount: 0, notes: '' };
                    }
                    selectTable(currentOrder.tableId, false); // false to skip saving the empty order
                } else {
                    renderCurrentOrder(); // Render empty order if no table is selected
                }
            } catch (error) {
                console.error("Failed to fetch initial data:", error);
                showNotification(`Error loading data: ${error.message}`);
            } finally {
                isProcessing = false;
            }
        };

        // Add a listener for database updates (if implemented in your main/preload)
        if (window.electronAPI.onOrdersUpdated) {
            window.electronAPI.onOrdersUpdated(() => {
                showNotification('Orders updated - refreshing data...');
                fetchData();
            });
        }

        // --- MENU REFRESH ---
        if (window.electronAPI.onMenuUpdated) {
            window.electronAPI.onMenuUpdated(() => {
                showNotification('Menu items updated - refreshing menu and data...');
                fetchData();
            });
        }
        
        // --- TABLES/DESK REFRESH ---
        if (window.electronAPI.onTablesUpdated) {
            window.electronAPI.onTablesUpdated(() => {
                showNotification('Tables list updated - refreshing data...');
                fetchData();
            });
        }

        if (window.electronAPI.onCategoriesUpdated) {
            window.electronAPI.onCategoriesUpdated(() => {
                showNotification('Categories updated - refreshing data...');
                fetchData();
            });
        }
        
        // NEW: SETTINGS/CURRENCY REFRESH LISTENER
        if (window.electronAPI.onSettingsUpdated) {
            window.electronAPI.onSettingsUpdated(async () => {
                showNotification('Settings updated - refreshing currency, tax, and discount rates...');
                // The safest way to handle settings changes (tax, currency) is to refetch all data.
                await fetchData(); 
            });
        }
        
        // Initial fetch when the DOM is ready
        document.addEventListener('DOMContentLoaded', fetchData);
        // ----------------------------------


        // ---------- TABLE & ORDER MANAGEMENT ----------

        const selectTable = (tableId, shouldSave = true) => {
            const id = parseInt(tableId);
            if (currentOrder.tableId === id && currentOrder.items.length > 0) {
                // Do nothing if same table is clicked with active items (user may be intending to confirm the selection)
                return;
            }

            // 1. Save old order state if necessary
            if (currentOrder.tableId !== null && shouldSave) {
                saveCurrentOrder(currentOrder.tableId);
            }

            if (id === currentOrder.tableId) {
                // 2. Clear selection if re-clicking a selected table with no active items
                currentOrder = { tableId: null, orderId: null, items: [], discount: 0, notes: '' };
                document.getElementById('mobile-table-selector').value = '';
            } else {
                // 3. Switch to new table
                const existing = ongoingOrders.find(o => o.tableId === id);
                // If existing order, load it. If not, create a new one with a null orderId (will be set on first send to kitchen)
                currentOrder = existing ? JSON.parse(JSON.stringify(existing)) : { tableId: id, orderId: null, // Will be set by DB on 'Send to Kitchen'
                    items: [], discount: 0, notes: '' 
                };
                document.getElementById('mobile-table-selector').value = id;
            }
            
            const table = tables.find(t => t.id === currentOrder.tableId);
            document.getElementById('header-table-info').textContent = currentOrder.tableId 
                ? `Table ${currentOrder.tableId}${currentOrder.orderId ? ` - Order #${currentOrder.orderId}` : ''}` 
                : 'Select a table to begin';
            document.getElementById('order-table-info').textContent = currentOrder.tableId 
                ? `(Table ${currentOrder.tableId})` 
                : '';
            
            updateMenuPanelState();
            resetKitchenNotes();
            renderTables();
            renderCurrentOrder();
        };

        const saveCurrentOrder = tableId => {
            const orderIndex = ongoingOrders.findIndex(o => o.tableId === tableId);
            const table = tables.find(x => x.id === tableId);

            if (!currentOrder.items.length) {
                // Only remove from ongoingOrders if it's already there (to clear an old one)
                if (orderIndex > -1) ongoingOrders.splice(orderIndex, 1);
                if (table) table.status = 'open';
                return;
            }

            const { subtotal, total } = calculateSummary(currentOrder.items, currentOrder.discount);
            currentOrder.subtotal = subtotal;
            currentOrder.total = total;
            currentOrder.notes = getKitchenNotes();

            // NOTE: We don't save to the *database* here, only the *local ongoingOrders* state
            // Database saving happens only in handleSendToKitchen and handleConfirmPayment.

            if (orderIndex > -1) {
                // Update existing ongoing order
                ongoingOrders[orderIndex] = JSON.parse(JSON.stringify(currentOrder));
            } else {
                // Add new ongoing order
                ongoingOrders.push(JSON.parse(JSON.stringify(currentOrder)));
            }

            if (table) table.status = currentOrder.orderId ? 'ongoing' : 'selected';
        };

        const addItemToOrder = id => {
            if (!currentOrder.tableId) return showNotification('Select a table first!');

            const item = menuItems.find(i => i.id === id);
            
            // Check if item already exists in the order
            const ex = currentOrder.items.find(i => i.id === id);
            if (ex) {
                ex.qty++;
            } else {
                // Add new item, mapping properties
                currentOrder.items.push({
                    id: item.id,
                    qty: 1,
                    name: item.name,
                    price: item.price,
                    category: item.category,
                    icon: item.icon, // Include icon
                    code: item.code // Include code
                });
            }
            renderCurrentOrder();
        };

        const updateQuantity = (index, delta) => {
            const item = currentOrder.items[index];
            item.qty += delta;
            if (item.qty <= 0) {
                currentOrder.items.splice(index, 1);
            }
            renderCurrentOrder();
        };

        const removeItem = index => {
            currentOrder.items.splice(index, 1);
            renderCurrentOrder();
        };

        const clearCurrentOrder = () => {
            const tid = currentOrder.tableId;
            const t = tables.find(x => x.id === tid);
            if (t) t.status = 'open'; // Reset table status
            
            // Remove from local ongoing orders state
            ongoingOrders = ongoingOrders.filter(o => o.tableId !== tid);
            
            // Reset current order state (keeping tableId if selected, otherwise null)
            currentOrder = { tableId: tid, orderId: null, items: [], discount: 0, notes: '' };
            
            // Update the UI
            document.getElementById('header-table-info').textContent = 'Select a table to begin';
            document.getElementById('order-table-info').textContent = '';
            document.getElementById('mobile-table-selector').value = '';
            resetKitchenNotes();
            updateMenuPanelState();
            renderCurrentOrder();
            renderTables();
        };

        const renderCategoryTags = () => {
            const cats = [...new Set(menuItems.map(i => i.category))].sort();
            const container = document.getElementById('category-tags');
            container.innerHTML = `<span class="category-tag active" data-category="All" onclick="filterMenu('All',this)" tabindex="0" role="button">All</span>`;
            cats.forEach(c => {
                const tag = document.createElement('span');
                tag.className = 'category-tag';
                tag.textContent = c;
                tag.setAttribute('data-category', c);
                tag.setAttribute('tabindex', 0);
                tag.setAttribute('role', 'button');
                tag.onclick = () => filterMenu(c, tag);
                tag.onkeydown = e => (e.key === 'Enter' || e.key === ' ') && filterMenu(c, tag);
                container.appendChild(tag);
            });
            activeCategory = 'All';
        };

        const renderTables = () => {
            const grid = document.getElementById('tables-grid');
            grid.innerHTML = '';
            tables.forEach(t => {
                const card = document.createElement('div');
                card.className = `table-card-compact status-${t.status} ${t.id === currentOrder.tableId ? 'status-selected' : ''}`;
                card.textContent = t.name;
                card.tabIndex = 0;
                card.onclick = () => selectTable(t.id);
                grid.appendChild(card);
            });

            // mobile selector
            const sel = document.getElementById('mobile-table-selector');
            sel.innerHTML = '<option value="">Select Table...</option>';
            tables.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                if (t.id === currentOrder.tableId) opt.selected = true;
                sel.appendChild(opt);
            });
        };

        const renderMenuItems = (search = '', cat = activeCategory) => {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            const filtered = menuItems.filter(i => {
                const matchCat = cat === 'All' || i.category === cat;
                // Search by name, code, or ID
                const matchSearch = !search || 
                                    i.name.toLowerCase().includes(search.toLowerCase()) || 
                                    (i.code && i.code.toString().toLowerCase().includes(search.toLowerCase())) || 
                                    i.id.toString() === search;
                return matchCat && matchSearch;
            });

            filtered.forEach(i => {
                const card = document.createElement('div');
                card.className = 'menu-item-card';
                card.tabIndex = 0;
                card.onclick = () => addItemToOrder(i.id);
                card.onkeydown = e => (e.key === 'Enter' || e.key === ' ') && addItemToOrder(i.id);
                card.innerHTML = `
                    <div class="item-icon"><i class="${i.icon}"></i></div>
                    <div class="item-name">${i.name} (${i.code})</div>
                    <div class="item-price">${formatCurrency(i.price)}</div>`;
                grid.appendChild(card);
            });
        };

        const renderCurrentOrder = () => {
            const list = document.getElementById('current-order-list');
            list.innerHTML = '';

            if (!currentOrder.items.length) {
                list.innerHTML = '<li id="empty-order-placeholder">No items added yet.</li>';
            } else {
                currentOrder.items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'order-item';
                    const itemTotal = item.price * item.qty;
                    li.innerHTML = `
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price">${formatCurrency(item.price)}</div>
                        </div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="updateQuantity(${index}, 1)">+</button>
                            <span class="qty-value" onclick="openNumpad('qty', 'integer', ${item.qty}, ${index})">${item.qty}</span>
                            <button class="qty-btn" onclick="updateQuantity(${index}, -1)">-</button>
                        </div>
                        <div class="item-total" style="font-weight: 600;">${formatCurrency(itemTotal)}</div>
                        <button class="remove-btn" onclick="removeItem(${index})">X</button>
                    `;
                    list.appendChild(li);
                });
            }

            // Update Summary
            const { subtotal, tax, discount, total } = calculateSummary(currentOrder.items, currentOrder.discount);
            document.getElementById('summary-subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('summary-tax').textContent = formatCurrency(tax);
            document.getElementById('summary-discount').textContent = formatCurrency(discount);
            document.getElementById('summary-total').textContent = formatCurrency(total);
            
            // DYNAMICALLY UPDATE TAX ROW
            const taxRow = document.getElementById('tax-row');
            taxRow.querySelector('span:first-child').textContent = `Tax (${globalSettings.TAX_RATE}%)`;
            taxRow.style.display = globalSettings.TAX_ENABLED ? 'flex' : 'none';
            
            // DYNAMICALLY UPDATE DISCOUNT ROW
            const discountRow = document.getElementById('discount-row');
            discountRow.style.display = globalSettings.DISCOUNT_ENABLED ? 'flex' : 'none';
        };

        // ---------- NUMPAD ----------
        let numpadCallback = null;
        let numpadTargetElement = null;

        const openNumpad = (target, mode, init = 0, idx = null, elementId = null) => {
            closeModal('payment-modal');
            globalNumpadTarget = target;
            globalNumpadMode = mode;
            
            // Use elementId if passed, otherwise fall back to global Numpad Display
            numpadTargetElement = elementId ? document.getElementById(elementId) : document.getElementById('numpad-display');

            const disp = document.getElementById('numpad-display');
            const title = document.getElementById('numpad-title');
            
            title.textContent = target === 'qty' ? 'Enter Quantity' 
                : target === 'discount' ? 'Enter Discount' 
                : target === 'payment' ? 'Enter Payment Amount' 
                : target === 'search' ? 'Enter Item ID/Code' 
                : 'Enter Value';
            
            let val = mode === 'integer' ? (parseInt(init) || 0).toString() 
                : mode === 'decimal' ? (parseFloat(init) === 0 ? '0' : (parseFloat(init) || 0).toString()) 
                : (init || '');
            
            disp.textContent = val;

            document.getElementById('numpad-modal').setAttribute('data-item-index', idx ?? '');
            
            document.querySelectorAll('.numpad-key[data-key="."], .numpad-key[data-key="00"]')
                .forEach(b => b.style.display = mode === 'decimal' ? 'block' : 'none');
            
            setTimeout(() => document.getElementById('numpad-modal').classList.add('is-active'), 10);
        };

        const handleNumpadInput = (key, cur) => {
            if (key === 'C') return '0';
            if (key === 'DEL') return cur.slice(0, -1) || '0';
            
            if (cur === '0' && key !== '0' && key !== '00' && key !== '.') cur = '';
            if (cur === '-0' && key !== '0' && key !== '00' && key !== '.') cur = '-';
            
            if (globalNumpadMode === 'integer') {
                if (key === '.') return cur;
                if (key === '00') key = '0';
                return cur + key;

            } else if (globalNumpadMode === 'decimal') {
                if (key === '.') {
                    return cur.includes('.') ? cur : cur + '.';
                }
                if (key === '00') {
                    if (cur === '0') return cur;
                    if (cur.includes('.')) {
                        const [w, d] = cur.split('.');
                        if (d.length >= 2) return cur;
                        let add = '00'.slice(0, 2 - d.length);
                        return cur + add;
                    }
                }
                
                // Max 2 decimal places
                if (cur.includes('.')) {
                    const [w, d] = cur.split('.');
                    if (d.length >= 2) return cur;
                }
                
                return cur + key;
            }
            return cur + key;
        };
        
        // Numpad key event listener
        document.querySelectorAll('.numpad-key').forEach(k => k.addEventListener('click', () => {
            const disp = document.getElementById('numpad-display');
            const cur = disp.textContent;
            const key = k.dataset.key;

            if (key === 'ENTER') {
                let val = disp.textContent;
                const idx = document.getElementById('numpad-modal').dataset.itemIndex;

                if (globalNumpadTarget === 'qty' && idx !== '') {
                    const numVal = parseInt(val) || 0;
                    if (numVal <= 0) currentOrder.items.splice(idx, 1);
                    else currentOrder.items[idx].qty = numVal;
                    renderCurrentOrder();
                } else if (globalNumpadTarget === 'search') {
                    document.getElementById('menu-search').value = val;
                    const active = document.querySelector('.category-tag.active');
                    filterMenu(active ? active.dataset.category : 'All', active);
                } else if (globalNumpadTarget === 'payment') {
                    const num = parseFloat(val) || 0;
                    val = num.toFixed(2);
                    document.getElementById('payment-amount').value = val;
                    // Auto-update change due
                    const totalDueText = document.getElementById('payment-total-due').textContent;
                    // Use globalSettings.CURRENCY_SYMBOL for replacement
                    const totalDue = parseFloat(totalDueText.replace(new RegExp(`^${globalSettings.CURRENCY_SYMBOL.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}`), ''));
                    const change = (num - totalDue).toFixed(2);
                    document.getElementById('payment-change').textContent = formatCurrency(change);
                } else if (globalNumpadTarget === 'discount') {
                    const num = parseFloat(val) || 0;
                    currentOrder.discount = Math.max(0, num);
                    renderCurrentOrder();
                }

                closeModal('numpad-modal');
                // Re-open payment modal if target was 'payment'
                if (globalNumpadTarget === 'payment') {
                    document.getElementById('payment-modal').classList.add('is-active');
                }

            } else {
                disp.textContent = handleNumpadInput(key, cur);
            }
        }));

        // Menu Search Click Handler
        document.getElementById('menu-search').addEventListener('click', e => {
            e.preventDefault();
            openNumpad('search', 'integer', document.getElementById('menu-search').value || '');
        });

        // Discount click handler
        // UPDATED: Check globalSettings.DISCOUNT_ENABLED before opening Numpad
        document.getElementById('summary-discount').parentElement.addEventListener('click', () => {
            if (globalSettings.DISCOUNT_ENABLED && currentOrder.tableId) {
                openNumpad('discount', 'decimal', currentOrder.discount);
            } else if (!globalSettings.DISCOUNT_ENABLED) {
                showNotification('Discount feature is disabled in settings.');
            }
        });


        // ---------- ORDER ACTIONS ----------
       const handleSendToKitchen = async () => {
        if (isProcessing || !currentOrder.tableId || !currentOrder.items.length) {
            return showNotification('Add items to an order and select a table first!');
        }

        isProcessing = true;
        try {
            const { total } = calculateSummary(currentOrder.items, currentOrder.discount);
            const notes = getKitchenNotes();

            const orderData = {
                desk_id: currentOrder.tableId,
                price: total.toFixed(2),
                products: currentOrder.items.map(item => ({
                    id: item.id,
                    qty: item.qty,
                    code: item.code || null,
                    name: item.name,
                    image: item.icon,
                    price: item.price.toFixed(2),
                    category: item.category
                })),
                notes: notes,
            };

            if (currentOrder.orderId) {
                // Update existing PENDING order (only locally in this mock, but normally a DB update is needed)
                saveCurrentOrder(currentOrder.tableId); 
                
                // FIX: Notification for update should show quickly
                showNotification('Order updated locally and sent to kitchen printer.'); 
                
            } else {
                // Save new order to DB (active = 'pending')
                const result = await window.electronAPI.sendOrderToKitchen(orderData);
                if (result.success) {
                    currentOrder.orderId = result.new_order_id;
                    currentOrder.notes = notes;
                    saveCurrentOrder(currentOrder.tableId); // Save to local state with new ID
                    const t = tables.find(x => x.id === currentOrder.tableId);
                    if (t) t.status = 'ongoing';
                    renderTables(); // Update table status in UI
                    
                    // FIX: Show notification immediately after data is updated/saved
                    showNotification(`Order #${currentOrder.orderId} sent to kitchen!`);
                    
                } else {
                    showNotification(`Error: ${result.message}`);
                }
            }
            
            // NEW FIX: Open the kitchen print window AFTER the notification to prevent delay
            // This assumes you have a print functionality that opens a new window:
            const win = window.open('print/kitchen-ticket.html', '_blank', 'width=400,height=600');
            win.onload = () => win.postMessage({ type: 'kitchen-ticket', order: JSON.parse(JSON.stringify(currentOrder)) /* other data */ }, '*');

            resetKitchenNotes();

        } catch (error) {
            console.error("Error sending order to kitchen:", error);
            showNotification(`Failed to send order: ${error.message}`);
        } finally {
            isProcessing = false;
        }
    };

        const openPaymentModal = () => {
            if (!currentOrder.tableId || !currentOrder.items.length) return showNotification('Add items and select a table first!');
            
            // Recalculate total just in case
            const { total } = calculateSummary(currentOrder.items, currentOrder.discount);
            
            document.getElementById('payment-modal-table').textContent = `Table ${currentOrder.tableId}`;
            document.getElementById('payment-total-due').textContent = formatCurrency(total);
            document.getElementById('payment-amount').value = total.toFixed(2); // Prefill with total
            document.getElementById('payment-change').textContent = formatCurrency(0); // Change is 0 initially
            
            // Set default payment mode to 'Cash' and reset buttons
            selectedPaymentMode = 'Cash';
            document.querySelectorAll('#payment-methods .method-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.method === 'Cash') btn.classList.add('active');
                btn.onclick = () => {
                    document.querySelectorAll('#payment-methods .method-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedPaymentMode = btn.dataset.method;
                    // Recalculate change on method change if amount paid is still total due
                    const paid = parseFloat(document.getElementById('payment-amount').value);
                    const change = (paid - total).toFixed(2);
                    document.getElementById('payment-change').textContent = formatCurrency(change);
                };
            });
            
            document.getElementById('finish-bill-btn').disabled = false;
            document.getElementById('payment-modal').classList.add('is-active');
        };

      const handleConfirmPayment = async () => {
    if (isProcessing) return;
    const { total } = calculateSummary(currentOrder.items, currentOrder.discount);
    const paid = parseFloat(document.getElementById('payment-amount').value);
    
    // --- ADDED: Calculate change amount needed for paymentData ---
    const change = paid - total; 

    if (paid < total || isNaN(paid)) {
        // If amount paid is less than total, open the Numpad to force entry
        closeModal('payment-modal');
        openNumpad('payment', 'decimal', document.getElementById('payment-amount').value);
        return; // Stop processing and wait for Numpad entry
    }

    if (!currentOrder.orderId) {
        // Should not happen if Send to Kitchen is followed, but as a safeguard:
        showNotification('Order must be sent to kitchen first!');
        return;
    }

    isProcessing = true;
    const btn = document.getElementById('finish-bill-btn');
    btn.disabled = true;

    try {
        const paymentData = { 
            order_id: currentOrder.orderId, 
            payment_mode: selectedPaymentMode,
            // --- FIX: Pass the amount paid and change amount to the main process handler ---
            amount_paid: paid,
            change_amount: change,
        };

        // Call db:updateOrderToPaid (updates active = 'paid' in db.js)
        const result = await window.electronAPI.updateOrderToPaid(paymentData);

        if (result.success) {
            // NOTE: The 'const change = paid - total;' line below is now redundant, 
            // but is left for minimal change, as it was in the success block. 
            // The value 'change' is available from the scope above.
            // const change = paid - total; 

            // Mock: Log the final receipt data
            console.log('--- FINAL RECEIPT ---', {
                order: JSON.parse(JSON.stringify(currentOrder)),
                payment: { 
                    paid, 
                    change, // Uses the 'change' value from the scope above
                    method: selectedPaymentMode, 
                    total, 
                    // Use dynamic settings for tax rate
                    tax_rate: globalSettings.TAX_ENABLED ? globalSettings.TAX_RATE.toFixed(1) : 0, 
                },
            });

            closeModal('payment-modal');
            
            // Reset local state after successful payment
            ongoingOrders = ongoingOrders.filter(o => o.tableId !== currentOrder.tableId);
            const t = tables.find(x => x.id === currentOrder.tableId);
            if (t) t.status = 'open';
            
            currentOrder = { tableId: null, orderId: null, items: [], discount: 0, notes: '' };

            document.getElementById('header-table-info').textContent = 'Select a table to begin';
            document.getElementById('order-table-info').textContent = '';
            document.getElementById('mobile-table-selector').value = '';
            resetKitchenNotes();
            updateMenuPanelState();
            renderTables();
            renderCurrentOrder();
            showNotification(`Bill finalized! Change: ${formatCurrency(change)}`);
            const win = window.open('print/receipt.html', '_blank', 'width=400,height=600');
            win.onload = () => win.postMessage({ type: 'shop-ticket', order: JSON.parse(JSON.stringify(currentOrder)) /* other data */ }, '*');
        } else {
            showNotification(`Error: ${result.message}`);
            btn.disabled = false; // Re-enable button on error
        }
    } catch (error) {
        console.error("Error confirming payment:", error);
        showNotification(`Failed to process payment: ${error.message}`);
        btn.disabled = false;
    } finally {
        isProcessing = false;
    }
};
document.getElementById('open-reports-page').addEventListener('click', () => { 
        // Tell Electron (via preload.js) to open the new reports window
        window.electronAPI.openReportsPage();
});


        // Keyboard navigation helpers
        document.addEventListener('keydown', e => {
            // Escape key closes open modals/menus
            if (e.key === 'Escape') {
                if (document.getElementById('slide-menu').classList.contains('open')) toggleMenu();
                if (document.getElementById('numpad-modal').classList.contains('is-active')) closeModal('numpad-modal');
                if (document.getElementById('payment-modal').classList.contains('is-active')) closeModal('payment-modal');
            }
        });
async function loadTables() {
    try {
        // Fetch the list of tables from your database through Electron IPC
        tables = await window.api.getDesk(); // <-- this should exist in your preload/main

        // Then re-render the table cards
        renderTables();
    } catch (err) {
        console.error("Failed to load tables:", err);
    }
}
   


        // expose for inline handlers
        window.selectTable = selectTable;
        window.addItemToOrder = addItemToOrder;
        window.removeItem = removeItem;
        window.updateQuantity = updateQuantity;
        window.handleSendToKitchen = handleSendToKitchen;
        window.openPaymentModal = openPaymentModal;
        window.handleConfirmPayment = handleConfirmPayment;
        window.clearCurrentOrder = clearCurrentOrder;
        window.toggleMenu = toggleMenu;
        window.closeModal = closeModal;
        window.openNumpad = openNumpad;
        window.navigateTo = navigateTo;
        window.logout = logout;
        window.renderMenuItems = renderMenuItems; // Expose for oninput search
        window.filterMenu = filterMenu; // Expose for category tags

        document.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(localStorage.getItem('currentUser') || 'null');
            // Assuming there's an element with id="user-info" in the header or menu
            const userInfoElement = document.getElementById('user-info'); 
            if (user && userInfoElement) {
                userInfoElement.textContent = `Logged in as: ${user.name}`;
            }
            loadTables();
        });
    </script>
</body>
</html>