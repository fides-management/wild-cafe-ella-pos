<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Past Orders • Wild Cafe POS</title>
    <style>
      :root {
        --accent:#1e40af;--bg:#f8fafc;--card:#fff;--text:#1f2937;--success:#059669;--danger:#ef4444;--border:#e5e7eb;
      }
      /* Updated font-family to a system stack for guaranteed offline use */
      body{font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;background:var(--bg);margin:0;padding:20px}
      .container{max-width:1200px;margin:auto;background:var(--card);padding:30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
      h2{color:var(--accent);border-bottom:2px solid var(--border);padding-bottom:12px;margin-bottom:24px;font-size:1.5rem}
      .back-link{display:inline-block;margin-bottom:20px;color:var(--accent);text-decoration:none;font-weight:500}
      .back-link:hover{text-decoration:underline}
      .filters{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;align-items:end}
      .filters input,.filters button{padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:1rem}
      .filters input{flex:1;min-width:140px}
      .filters button{background:var(--accent);color:white;border:none;cursor:pointer}
      .filters button:hover{opacity:.9}
      .filters .clear-btn{background:#e5e7eb;color:var(--text)}
      table{width:100%;border-collapse:collapse;font-size:.9rem}
      th,td{padding:14px 12px;border:1px solid var(--border);text-align:left;vertical-align:top}
      th{background:#f8fafc;font-weight:600;color:var(--text)}
      .order-id{font-family:monospace;font-weight:600}
      .total{font-weight:bold;color:var(--success)}
      .items-list{white-space:pre-line;font-family:'Courier New',monospace;font-size:.85rem;background:#f9fafb;padding:8px;border-radius:4px;line-height:1.4}
      .notes{color:var(--danger);font-style:italic;margin-top:6px;display:block}
      .empty{text-align:center;padding:60px 20px;color:#9ca3af;border:2px dashed var(--border);border-radius:12px;font-size:1.1rem}
      .loading{text-align:center;padding:40px;color:#6b7280}
      .remove-btn{background:none;border:none;color:var(--danger);cursor:pointer;font-size:1.1rem;padding:4px}
      .remove-btn:hover{transform:scale(1.1)}
      .table-badge{background:#e0e7ff;color:#1e40af;padding:2px 8px;border-radius:12px;font-size:.75rem;font-weight:600}
    </style>
</head>
<body>
  <div class="container">
    <h2>Past Orders</h2>
    <a href="#" id="back-btn" class="back-link">Back to POS</a>

    <div class="filters">
      <input type="date" id="date-from" placeholder="From">
      <input type="date" id="date-to" placeholder="To">
      <input type="text" id="search" placeholder="Search by Table #, Item, Note...">
      <button id="clear-filters" class="clear-btn">Clear</button>
    </div>

    <div id="content">
      <div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading orders...</div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    let allOrders = [];
    let CURRENCY = 'Rs';

    // --- Toast ---
    const toast = (msg, type = 'error') => {
      const t = document.createElement('div');
      t.style.cssText = `position:fixed;bottom:20px;right:20px;padding:16px 20px;background:${type==='success'?'#10b981':'#ef4444'};color:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:9999;font-weight:500;min-width:300px;transform:translateY(100px);opacity:0;transition:all .3s`;
      t.innerHTML = `<i class="fas ${type==='success'?'fa-check-circle':'fa-exclamation-triangle'}"></i> ${msg}`;
      document.body.appendChild(t);
      setTimeout(() => { t.style.transform='translateY(0)'; t.style.opacity='1'; }, 10);
      setTimeout(() => { t.style.transform='translateY(100px)'; t.style.opacity='0'; setTimeout(() => t.remove(), 300); }, 3000);
    };

    // --- Load Data ---
    const load = async () => {
      try {
        const [currency, orders] = await Promise.all([
          window.electronAPI.invoke('menu-get-currency'),
          window.electronAPI.invoke('orders-get-all')
        ]);
        CURRENCY = currency;
        allOrders = orders.map(o => {
          const data = JSON.parse(o.order_data || '{}');
          // Add table for filtering, defaulting to '—' if not present
          return { ...o, data, table: data.table || '—' }; 
        });
        render(filterOrders());
      } catch (e) {
        console.error(e);
        $('#content').innerHTML = '<div class="empty">Failed to load orders. Check console.</div>';
      }
    };

    // --- Filter ---
    const filterOrders = () => {
      const from = $('#date-from').value;
      const to = $('#date-to').value;
      const search = $('#search').value.toLowerCase().trim();

      return allOrders.filter(o => {
        const date = new Date(o.order_date);
        // Date filtering
        if (from && date < new Date(from)) return false;
        // Check until the end of the 'to' day
        if (to && date > new Date(to + 'T23:59:59')) return false; 
        
        // Text search
        if (search) {
          const itemsString = (o.data.items || []).map(it => it.name).join(' ');
          const text = `${o.table} ${o.payment_method} ${o.data.notes || ''} ${itemsString}`.toLowerCase();
          return text.includes(search);
        }
        return true;
      });
    };

    // --- Render ---
    const render = (orders) => {
      if (!orders.length) {
        $('#content').innerHTML = '<div class="empty">No orders match your filters.</div>';
        return;
      }

      const html = `
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Date & Time</th>
                <th>Table</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Items</th>
                <th>Remove</th>
              </tr>
            </thead>
            <tbody>
              ${orders.map(o => {
                const items = (o.data.items || []).map(it =>
                  `${it.qty}x ${escape(it.name)} ${CURRENCY}${Number(it.price * it.qty).toFixed(2)}`
                ).join('\n');
                return `
                  <tr data-id="${o.id}">
                    <td class="order-id">#${o.id}</td>
                    <td>${new Date(o.order_date).toLocaleString()}</td>
                    <td><span class="table-badge">${escape(o.table)}</span></td>
                    <td class="total">${CURRENCY}${Number(o.final_total).toFixed(2)}</td>
                    <td>${escape(o.payment_method || '-')}</td>
                    <td>
                      <div class="items-list">${items}</div>
                      ${o.data.notes ? `<small class="notes">Note: ${escape(o.data.notes)}</small>` : ''}
                    </td>
                    <td><button class="remove-btn" onclick="removeOrder(${o.id})" title="Delete Order"><i class="fas fa-trash-alt"></i></button></td>
                  </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>`;
      $('#content').innerHTML = html;
    };

    const escape = s => { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; };

    // --- Remove Order ---
    window.removeOrder = async (id) => {
      if (!confirm('Delete this order permanently?')) return;
      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (row) row.classList.add('loading');
      try {
        await window.electronAPI.invoke('order-remove', id);
        toast('Order removed', 'success');
        allOrders = allOrders.filter(o => o.id !== id);
        render(filterOrders());
      } catch (e) {
        toast('Remove failed: ' + e.message);
      } finally {
        if (row) row.classList.remove('loading');
      }
    };

    // --- Filter Events ---
    $('#date-from').addEventListener('change', () => render(filterOrders()));
    $('#date-to').addEventListener('change', () => render(filterOrders()));
    $('#search').addEventListener('input', () => render(filterOrders()));
    $('#clear-filters').onclick = () => {
      $('#date-from').value = $('#date-to').value = $('#search').value = '';
      render(allOrders);
    };

    // --- Back ---
    $('#back-btn').onclick = e => { e.preventDefault(); window.close(); };

    // --- Start ---
    load();
  </script>
</body>
</html>