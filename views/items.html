<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Menu Items • Wild Cafe POS</title>
  <style>
    :root{--accent:#1e40af;--bg:#f8fafc;--card:#fff;--danger:#ef4444;--success:#10b981}
    /* Updated font-family to a system stack for guaranteed offline use */
    body{font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;background:var(--bg);padding:20px;margin:0}
    .container{max-width:900px;margin:auto;background:var(--card);padding:30px;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    h2{color:var(--accent);border-bottom:2px solid #e5e7eb;padding-bottom:10px;margin-bottom:20px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:12px;border:1px solid #e5e7eb;text-align:left}
    th{background:#f3f4f6;font-weight:600;color:#1f2937}
    .btn{padding:8px 12px;border:none;border-radius:5px;cursor:pointer;font-weight:500;transition:opacity .2s;margin-left:5px}
    .btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{opacity:.9}
    .btn-secondary{background:#e5e7eb;color:#1f2937}.btn-secondary:hover{opacity:.9}
    .btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{opacity:.9}
    .form-group{margin-bottom:15px;display:flex;gap:10px;align-items:flex-end}
    .form-group label{font-weight:600;margin-bottom:5px;display:block}
    .form-group input{padding:10px;border:1px solid #ccc;border-radius:5px;width:100%;box-sizing:border-box}
    .form-group > div{flex:1}.form-group .full-width{flex:3}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.6)}
    .modal-content{background:#fefefe;margin:10% auto;padding:25px;border:1px solid #888;width:80%;max-width:450px;border-radius:8px}
    .close{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}.close:hover{color:#000}
    .loading{opacity:.6;pointer-events:none}
    /* Toast Styling Update */
    #toast{position:fixed;bottom:20px;right:20px;min-width:300px;background:#1f2937;color:#fff;padding:16px;border-radius:8px;
           box-shadow:0 6px 16px rgba(0,0,0,.4);z-index:9999;display:flex;align-items:center;gap:15px;opacity:0;
           transition:opacity .3s,transform .3s;transform:translateY(20px);border:1px solid #fff3}
    #toast.show{opacity:1;transform:translateY(0)}
    #toast.success{background:var(--success);border-color:#fff5}
    #toast.error{background:var(--danger);border-color:#fff5}
    #toast-icon {font-size: 1.4em; line-height: 1;} /* Simple, reliable styling for the icon/emoji */
    
    /* Pagination Styling */
    .pagination-controls{display:flex;justify-content:center;align-items:center;margin-top:20px;gap:10px}
    .pagination-controls button{padding:8px 15px;background:#f3f4f6;border:1px solid #e5e7eb;cursor:pointer;border-radius:5px}
    .pagination-controls button:disabled{opacity:.5;cursor:not-allowed}
    .pagination-controls span{font-weight:600;color:#1f2937}
  </style>
</head>
<body>
  <div class="container">
    <h2>Menu Item Management</h2>
   <button id="back-btn" style="background:none;border:none;color:var(--accent);font-size:1rem;cursor:pointer;margin-bottom:20px;text-decoration:underline;">
      Back to POS
    </button>

    <h3>Add New Item</h3>
    <div class="form-group">
      <div style="flex: 2.5;"><label for="name">Name</label><input type="text" id="name" required placeholder="e.g., Spicy Chicken Burger"></div>
      <div><label for="code">Code (4-digit)</label><input type="number" id="code" required placeholder="0000" min="0" max="9999"></div>
      <div><label for="category">Category</label>
        <input type="text" id="category" list="categories" required placeholder="Select or type category">
        <datalist id="categories"></datalist>
      </div>
      <div><label for="price">Price (<span id="currency">Rs</span>)</label><input type="number" step="0.01" id="price" required placeholder="0.00"></div>
      <div><label for="icon_class">Icon (FA)</label><input type="text" id="icon_class" value="fas fa-utensils" placeholder="e.g., fas fa-hamburger"></div>
      <button id="add-btn" class="btn btn-primary" style="height:42px;">+ Add Item</button>
    </div>

    <h3>Current Menu</h3>
    <div class="form-group" style="margin-top: -10px; align-items: center; gap: 0;">
      <div style="flex: 1; margin-right: 10px;">
        <label for="search" style="display: none;">Search</label>
        <input type="text" id="search" placeholder="Search by Name, ID, Code, or Category...">
      </div>
    </div>
    <div style="overflow-x:auto;">
      <table id="items-table">
        <thead><tr><th>ID</th><th>Icon</th><th>Name</th><th>Code</th><th>Category</th><th>Price</th><th>Actions</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    
    <div id="pagination-controls" class="pagination-controls" style="display: none;">
      <button id="prev-page" class="btn-secondary">Previous</button>
      <span id="page-info">Page 1 of 1</span>
      <button id="next-page" class="btn-secondary">Next</button>
    </div>

  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Edit Item</h3>
      <form id="edit-item-form">
        <input type="hidden" id="edit_id">
        <div class="form-group" style="display: block;">
            <label for="edit_name">Name</label>
            <input type="text" id="edit_name" required>
        </div>
        <div class="form-group" style="display: block;">
            <label for="edit_code">Code</label>
            <input type="number" id="edit_code" required min="0" max="9999">
        </div>
        <div class="form-group" style="display: block;">
            <label for="edit_category">Category</label>
            <input type="text" id="edit_category" list="categories" required>
        </div>
        <div class="form-group" style="display: block;">
            <label for="edit_price">Price (<span id="edit-currency">Rs</span>)</label>
            <input type="number" step="0.01" id="edit_price" required>
        </div>
        <div class="form-group" style="display: block;">
            <label for="edit_icon_class">Icon (FA)</label>
            <input type="text" id="edit_icon_class">
        </div>
        <button type="submit" id="save-btn" class="btn btn-primary">Save Changes</button>
      </form>
    </div>
  </div>

  <div id="toast"><span id="toast-icon"></span><span id="toast-msg"></span></div>

<script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    let items = [];
    let filteredItems = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    let CURRENCY = 'Rs'; // Global variable initialized with a default

    const toast = (msg, type = 'error') => {
        const t = $('#toast'), i = $('#toast-icon'), m = $('#toast-msg');
        t.className = type;
        i.textContent = type === 'success' ? '✔' : '❌'; // Offline-safe emoji icon
        m.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    };

    const escape = s => { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; };

    /* ---------- Currency Logic (New/Modified) ---------- */
    const updateCurrencyUI = async () => {
        try {
            const settings = await window.api.getSettings();
            CURRENCY = settings.currency_symbol || 'Rs';
            
            // Update the displays in the main form and the modal
            $('#currency').textContent = CURRENCY;
            document.getElementById('edit-currency').textContent = CURRENCY; 
            
            // Re-render the table to show the new currency symbol on all prices
            renderTable();
        } catch (e) {
            console.error('Error fetching currency:', e);
            toast('Failed to load currency symbol.', 'error');
        }
    };

    /* ---------- Pagination Logic ---------- */
    const updatePagination = () => {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        const controls = $('#pagination-controls');
        if (totalPages > 1) {
            controls.style.display = 'flex';
            $('#page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            $('#prev-page').disabled = currentPage === 1;
            $('#next-page').disabled = currentPage === totalPages;
        } else {
            controls.style.display = 'none';
        }
    };

    $('#prev-page').onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    };
    $('#next-page').onclick = () => {
        const totalPages = Math.ceil(filteredItems.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    };

    /* ---------- Render Table (Filtered & Paginated) ---------- */
    const renderItemRow = (item) => {
        // Use the global CURRENCY variable
        const priceDisplay = `${CURRENCY} ${parseFloat(item.price).toFixed(2)}`;
        
        return `<tr data-id="${item.id}">
            <td>${item.id}</td>
            <td><i class="${item.icon_class || 'fas fa-utensils'}"></i></td>
            <td>${escape(item.name)}</td>
            <td>${item.code}</td>
            <td>${escape(item.category)}</td>
            <td>${priceDisplay}</td>
            <td>
                <button class="btn btn-secondary" onclick="openEditModal(${item.id})">Edit</button>
                <button class="btn btn-danger" onclick="deleteItem(${item.id})">Delete</button>
            </td>
        </tr>`;
    };
    
    const renderTable = () => {
        const tbody = $('#items-table tbody');
        tbody.innerHTML = '';
        
        const searchTerm = $('#search').value.toLowerCase().trim();
        filteredItems = items.filter(it => 
            String(it.id).includes(searchTerm) || 
            String(it.code).includes(searchTerm) || 
            it.name.toLowerCase().includes(searchTerm) || 
            it.category.toLowerCase().includes(searchTerm)
        );

        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedItems = filteredItems.slice(startIndex, endIndex);

        paginatedItems.forEach(item => {
            tbody.innerHTML += renderItemRow(item);
        });

        updatePagination();
    };

    const refreshTable = async () => {
        try {
            // items.html (Corrected)
items = await window.electronAPI.fetchMenu();
            currentPage = 1;
            renderTable();
        } catch (e) {
            console.error('Failed to fetch items:', e);
            toast('Failed to load menu items.', 'error');
        }
    };

    /* ---------- Categories ---------- */
    const loadCategories = async () => {
        try {
            const categories = await window.api.getCategories();
            const datalist = $('#categories');
            datalist.innerHTML = categories.map(cat => `<option value="${escape(cat.name)}">`).join('');
        } catch (e) {
            console.error('Failed to load categories', e);
            toast('Failed to load categories');
        }
    };

    /* ---------- Initialization (Modified) ---------- */
    const load = async () => {
        try {
            // 1. NEW: Fetch and set currency first
            await updateCurrencyUI(); 
            
            // 2. Load other data
            await loadCategories();
            await refreshTable();

            // 3. NEW: Set up the real-time listener for currency changes
            if (window.api && window.api.onSettingsUpdated) {
                window.api.onSettingsUpdated(updateCurrencyUI); 
            }
            
        } catch (e) {
            console.error('load error:', e);
            toast('Loading failed – retrying in 3s', 'error');
            setTimeout(load, 3000);
        }
    };

    /* ---------- Search Logic ---------- */
    $('#search').oninput = () => {
        currentPage = 1; 
        renderTable();
    };

    /* ---------- Add (C in CRUD) ---------- */
    $('#add-btn').onclick = async () => {
        const n = $('#name').value.trim(), 
              cd = $('#code').value.trim(), 
              c = $('#category').value.trim(), 
              p = parseFloat($('#price').value), 
              i = $('#icon_class').value.trim() || 'fas fa-utensils';

        if (!n || !c || isNaN(p) || cd.length !== 4) return toast('Fill all fields correctly (Code must be 4 digits)', 'error');

        const btn = $('#add-btn');
        btn.classList.add('loading');
        try {
            await window.api.addMenuItem({ name: n, code: cd, category: c, price: p, icon_class: i });
            toast('Item added!', 'success');
            // Clear inputs
            $('#name').value = '';
            $('#code').value = '';
              $('#category').value = '';
            $('#price').value = '';
            // Refresh table to show new item
            await refreshTable(); 
        } catch (e) {
            console.error('add error:', e);
            toast('Add failed: ' + e.message, 'error');
        } finally {
            btn.classList.remove('loading');
        }
    };

    /* ---------- Edit Modal (R/U in CRUD) ---------- */
    window.openEditModal = id => {
        const item = items.find(i => i.id === id);
        if (!item) return toast('Item not found', 'error');

        const editCategoryInput = $('#edit_category');
    const datalistId = 'categories';

        // Set values in the modal form
        $('#edit_id').value = item.id;
        $('#edit_name').value = item.name;
        $('#edit_code').value = item.code;
        // $('#edit_category').value = item.category;
        editCategoryInput.value = item.category;
        // Use the global CURRENCY variable in the modal's label
        document.getElementById('edit-currency').textContent = CURRENCY;
        $('#edit_price').value = parseFloat(item.price).toFixed(2);
        $('#edit_icon_class').value = item.icon_class || 'fas fa-utensils';

        $('#editModal').style.display = 'block';

        itCategoryInput.removeAttribute('list');

    // 2. Re-add the list attribute using a tiny delay (setTimeout(0)).
    // This forces the browser to recognize the datalist link now that the input is visible.
    setTimeout(() => {
        editCategoryInput.setAttribute('list', datalistId);
        // This will now trigger the full list of suggestions.
    }, 0);
        
    };

    $('#edit-item-form').onsubmit = async e => {
      e.preventDefault();
      const id = $('#edit_id').value;
      const n = $('#edit_name').value.trim();
      const cd = $('#edit_code').value.trim();
      const c = $('#edit_category').value.trim();
      const p = parseFloat($('#edit_price').value);
      const i = $('#edit_icon_class').value.trim() || 'fas fa-utensils';

      if (!n || !c || isNaN(p) || cd.length !== 4) return toast('Fill all fields correctly (Code must be 4 digits)', 'error');
      
      const btn = $('#save-btn');
      btn.classList.add('loading');
      try {
        await window.api.updateMenuItem({ id, name: n, code: cd, category: c, price: p, icon_class: i });
        closeModal();
        toast('Item updated!', 'success');
        await refreshTable();
      } catch (e) {
        console.error('update error:', e);
        toast('Update failed: ' + e.message, 'error');
      } finally {
        btn.classList.remove('loading');
      }
    };

    /* ---------- Delete (D in CRUD) ---------- */
    window.deleteItem = async id => {
      if (!confirm('Delete this item?')) return;

      const row = document.querySelector(`tr[data-id="${id}"]`);
      if (row) row.classList.add('loading');

      try {
        await window.api.deleteMenuItem(id);
        toast('Item deleted!', 'success');
        await refreshTable(); // Refresh the table after deletion
        setTimeout(() => {
            window.close();
        }, 500); 
      } catch (e) {
        console.error('delete error:', e);
        toast('Delete failed: ' + e.message, 'error');
      } finally {
        if (row) row.classList.remove('loading');
      }
    };

    const closeModal = () => $('#editModal').style.display = 'none';
      window.onclick = e => { if (e.target === $('#editModal')) closeModal(); };
    $('#back-btn').onclick = () => window.close();; // Expose to the window object for the close button handler

    // Initial Load
    document.addEventListener('DOMContentLoaded', load);

    // Navigation
    //$('#back-btn').onclick = () => window.close(); // Assuming this closes the item management window
</script>
</body>
</html>